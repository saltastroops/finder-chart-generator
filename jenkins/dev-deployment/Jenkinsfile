@Library('saao-shared-library@run-python-tests') _

def success = true

pipeline {
  agent any
  stages {
    stage("Run tests") {
  agent {
    dockerfile {
      filename 'Dockerfile'
      dir 'jenkins/dev-deployment'
      args '-v finder-chart-generator-venv:/venv -u 0:0'
    }
  }
      steps {
        sh 'echo $PATH'
        sh 'poetry export -f requirements.txt --with dev --output requirements.txt'
        sh 'python -m pip install -r requirements.txt'
        script {
          success = saao.runPythonTests 'black': ['fcg', 'tests'], 'flake8': ['fcg', 'tests'], 'mypy': ['fcg', 'tests'], 'pytest': ['tests'], 'allure': true, 'warningsNextGeneration': true
//             'bandit': ['fcg'],
//             'black': ['fcg', 'tests'],
//             'flake8': ['fcg', 'tests'],
//             'isort': ['fcg', 'tests'],
//             'mypy': ['fcg', 'tests'],
//             'pytest': ['tests']
//          )
        }
      }
    }
//     stage("Deploy the site") {
//       steps {
//         script {
//           saao.deployContainer(
//             host: "${FCG_DEV_HOST}",
//             hostCredentialsId: 'fcg-dev-server-credentials',
//             imageName: 'finder-chart-generator',
//             registryCredentialsId: 'docker-registry-credentials',
//             registryUrl: "${DOCKER_REGISTRY}"
//           )
//         }
//       }
//     }
  }

  post {
    always {
      echo "SUCCESS?: $success"
//       unstash 'reports'
      script {
        saao.createPythonTestReports()
      }
      //cleanWs deleteDirs: true, patterns: [[pattern: 'allure-report', type: 'EXCLUDE']]
//       allure includeProperties: false, jdk: '', results: [[path: 'reports/allure']]
//       recordIssues(tools: [flake8(pattern: 'reports/warnings-next-generation/flake8.txt'), myPy(pattern: 'reports/warnings-next-generation/mypy.txt')])

      //cleanWs()
    }
  }
}
